#!/usr/bin/env bash
FOLD=$(tput cols)

function fDisplayOptions()
{
  cat <<EOF | fold -w ${FOLD} -s


usage: `basename $0` [options]

Export the context as variables for scripts or export specific variables. 

This pulls config data from:
 - Wovtools project config (./wovtools/config.json)
 - Wovtools global config ($HOME/.wovtools)
 - K8s config
 - git

And secrets/config:
 - Wovtools project compiled secrets (./wovtools/cache/secrets/current.json)


Command Options:

  -h/--help    : display these options
  -v/--version : version of wovtools
  --rcAWS      : convert a region code to an AWS code (ex. va-> us-east-1)
  --vh-label   : vh label in DockerHub repo
 
  Basic Configuration:
  -e           : echo the output
  -c           : run cluster config as well

  Secrets/Config:
  --envs       : print all the configuration as environment variables (sep lines)
  --conf       : print all the configuration as environment variables (one line)
  --exports    : runs all the configuration as environment variables (no output, sourced)
  --var X      : print this variable X

  Kubernetes Generation 
  NOTE: These use Make to run a script... not good... need better way to run
  --cm X       : only config used by plugin, (sep lines)
  --se X       : only secrets used by plugin, (sep lines)

XXX deprecated
  --export X   : export the environment variables in file X in wovtools/cache/conf/X (NOTE: removes comments)
  --env-var X  : print one variable of the environment variables (--var does all)
  --cmd X      : for commands on one line, echo the environment variables in file X in wovtools/cache/conf/X (NOTE: removes comments)
  --env X      : echo the environment variables in file X in wovtools/cache/conf/X (NOTE: removes comments)
  --qcmd X     :   ", quoted
  --sl X       :   ", string literal output

Example Usage:
  `basename $0`    : sets all environment variables
  `basename $0` -e : set and echo all environment variables
  `basename $0` --var X : set the env variable
  `basename $0` -e --var X : set and echo the env variable

EOF
}
if [ "$1" == '--help' ] || [ "$1" == '-h' ]; then fDisplayOptions; exit 0; fi

# Used to select between vh containers
# --------------------------------------------------------------------- 
if [ "$1" == "--vh-label" ]; then echo "0.1"; exit 0; fi

# --------------------------------------------------------------------- 
WOV_VERSION=0
WOV_BASEDIR=$(git rev-parse --show-toplevel)
export WOV_BASEDIR
SED=`which gsed`


if [ "$WOV_BASEDIR" == "" ]; then
  echo "ERROR: not in wovtools project (no git)."
  exit 1
elif [ ! -e "$WOV_BASEDIR/wovtools" ]; then
  echo "ERROR: not in wovtools project (no wovtools directory)."
  exit 1
elif [ ! -e "${WOV_BASEDIR}/wovtools/config.json" ]; then
  echo "ERROR: not in wovtools project (no wovtools/config.json file)."
  exit 1
fi



WOV_SECRETFILE=${WOV_BASEDIR}/wovtools/cache/secrets/current.json
export WOV_SECRETFILE





ECHOMODE=0
DOALL=1

# Standard Bash breakdown of context
K8S_CONTEXT=$(kubectl config current-context)
OLDIFS=$IFS
IFS='-'
array=( $K8S_CONTEXT )
IFS=$OLDIFS
#echo "value = ${array[2]}"
#echo ${array[*]}
WOV_KSTAGE=${array[5]}
WOV_KPROJECT=${array[4]}
WOV_NS=${WOV_KPROJECT}-${WOV_KSTAGE}
export WOV_BASEDIR
WOV_FLAVOR=${array[3]}
WOV_REGION=${array[2]}
WOV_PROVIDER=${array[1]}
WOV_CLTYPE=${array[0]}
WOV_CLUSTER=${WOV_CLTYPE}-${WOV_PROVIDER}-${WOV_REGION}-${WOV_FLAVOR}

# vars from git, if in project directory
WOV_PVER=$(git rev-list --count $(git rev-parse --abbrev-ref HEAD))
WOV_SVER=$(cd ${WOV_BASEDIR}/wovtools/secrets && git rev-list --count $(git rev-parse --abbrev-ref HEAD))
# WOV_USER=$(git config user.email | cut -d@ -f1)
WOV_USERNAME=$(git config user.name)
WOV_USEREMAIL=$(git config user.email)
export WOV_PVER
export WOV_SVER
#  export WOV_USER
export WOV_USERNAME
export WOV_USEREMAIL

# TODO:  optimize the jq calls into one, returning an array
#A=( `jq -r ". | ( .rootdir, .srcdir, .secretsdir, .compileddir, .containerdir, .registry, .wovtools )" ${dir_wovtools_rc}/.wovtools.json` )
#echo "A:${A[*]}:A"
#dir_root="${A[0]}"


WOV_ME=$(cat ${HOME}/.wovtools | jq -r '.me')
if [ "${WOV_ME}" == "null" ] ; then
  printf "\n\nERROR: You need to set 'me' in the wovtools/config.json file.\n"
  printf "  - This is a unique code in this project, to represent yourself. Try using your initials (assuming they are unique to your team).\n\n"
  exit 1

fi

WOV_PVERSION=$(cat ${WOV_BASEDIR}/wovtools/config.json | jq -r '.ver')
if [ "${WOV_PVERSION}" != "${WOV_VERSION}" ] && [ "${WOV_PVERSION}" != "initing" ] ; then
  printf "\n\nERROR: Your project version '${WOV_PVERSION}', does not match to the WovTools version '${WOV_VERSION}'.\n\n"
  exit 1
fi

WOV_WPROJECT=$(cat ${WOV_BASEDIR}/wovtools/config.json | jq -r '.project.project') 
WOV_PROJECTTYPE=$(cat ${WOV_BASEDIR}/wovtools/config.json | jq -r '.project.type') 
WOV_PROJECTTITLE=$(cat ${WOV_BASEDIR}/wovtools/config.json | jq -r '.project.title') 
WOV_PROJECTDESCRIPTION=$(cat ${WOV_BASEDIR}/wovtools/config.json | jq -r '.project.description') 
export WOV_WPROJECT
export WOV_PROJECTTYPE
export WOV_PROJECTTITLE
export WOV_PROJECTDESCRIPTION

# Track which mode we are in
#WOV_DEVMODE=$(cat ${WOV_BASEDIR}/wovtools/config.json | jq -r '.project.devmode') 
#if [ "$WOV_DEVMODE" == "" ]; then WOV_DEVMODE="remote"; fi
#export WOV_DEVMODE

WOV_ARCHIVEREPOSITORY=$(cat ${WOV_BASEDIR}/wovtools/config.json | jq -r '.archive.repository') 
WOV_ARCHIVEENV=$(cat ${WOV_BASEDIR}/wovtools/config.json | jq -r '.archive.env') 
export WOV_ARCHIVEREPOSITORY
export WOV_ARCHIVEENV

WOV_GSTAGE=$(git rev-parse --abbrev-ref HEAD)
WOV_STAGE=$WOV_GSTAGE
  # GSTAGE has priority since it can represent <initials>-local, for local namespaces.
export WOV_GSTAGE
export WOV_STAGE

## Set DEVMODE 
#if [[ ${WOV_GSTAGE} == "${WOV_KSTAGE}-l" ]]; then
#  WOV_DEVMODE=local
#elif [[ ${WOV_GSTAGE} == "${WOV_KSTAGE}-v" ]]; then
#  WOV_DEVMODE=virtual
#fi
#export WOV_DEVMODE

WOV_PROJECT=${WOV_WPROJECT}
export WOV_PROJECT

export K8S_CONTEXT
export WOV_CLUSTER
export WOV_NS
export WOV_CLTYPE
export WOV_PROVIDER
export WOV_REGION
export WOV_FLAVOR
export WOV_PROJECT
export WOV_KSTAGE

# --------------------------------------------------------------------- 
# Functions
# --------------------------------------------------------------------- 

function fDoEcho() 
{
  echo WOV_VERSION="${WOV_VERSION}"
  echo WOV_ME="${WOV_ME}"
  echo WOV_BASEDIR="${WOV_BASEDIR}"
  echo WOV_SECRETFILE="${WOV_SECRETFILE}"
  echo WOV_ARCHIVEREPOSITORY="${WOV_ARCHIVEREPOSITORY}"
  echo WOV_ARCHIVEENV="${WOV_ARCHIVEENV}"
  echo K8S_CONTEXT="$K8S_CONTEXT"
  echo WOV_CLUSTER="$WOV_CLUSTER"
  echo WOV_NS="$WOV_NS"
  echo WOV_CLTYPE="$WOV_CLTYPE"
  echo WOV_PROVIDER="$WOV_PROVIDER"
  echo WOV_REGION="$WOV_REGION"
  echo WOV_FLAVOR="$WOV_FLAVOR"
  echo WOV_PROJECT="$WOV_PROJECT"
  echo WOV_KSTAGE="$WOV_KSTAGE"
  echo WOV_GSTAGE="$WOV_GSTAGE"
  echo WOV_STAGE="$WOV_STAGE"
#  echo WOV_DEVMODE="${WOV_DEVMODE}"
  if [ "$RANCLUSTER" == "1" ]; then
    echo CL_REGION="$CL_REGION"
    echo CL_ZONES="${CL_ZONES}"
    echo CL_VPC="${CL_VPC}"
  fi

  echo WOV_PVER="$WOV_PVER"
  echo WOV_SVER="$WOV_SVER"
#    echo WOV_USER="$WOV_USER"
  echo WOV_USERNAME="$WOV_USERNAME"
  echo WOV_USEREMAIL="$WOV_USEREMAIL"
  echo WOV_PROJECT="$WOV_PROJECT"
  echo WOV_PROJECTTYPE="$WOV_PROJECTTYPE"
  echo WOV_PROJECTTITLE="$WOV_PROJECTTITLE"
  echo WOV_PROJECTDESCRIPTION="$WOV_PROJECTDESCRIPTION"
  echo WOV_KPROJECT="$WOV_KPROJECT"
  echo WOV_WPROJECT="$WOV_WPROJECT"
}

function fDoBashEcho() 
{
  printf "WOV_VERSION=\"${WOV_VERSION}\" "
  printf "WOV_ME=\"${WOV_ME}\" "
  printf "WOV_BASEDIR=\"${WOV_BASEDIR}\" "
  printf "WOV_ARCHIVEREPOSITORY=\"${WOV_ARCHIVEREPOSITORY}\" "
  printf "WOV_ARCHIVEENV=\"${WOV_ARCHIVEENV}\" "
  printf "K8S_CONTEXT=\"$K8S_CONTEXT\" "
  printf "WOV_CLUSTER=\"$WOV_CLUSTER\" "
  printf "WOV_NS=\"$WOV_NS\" "
  printf "WOV_CLTYPE=\"$WOV_CLTYPE\" "
  printf "WOV_PROVIDER=\"$WOV_PROVIDER\" "
  printf "WOV_REGION=\"$WOV_REGION\" "
  printf "WOV_FLAVOR=\"$WOV_FLAVOR\" "
  printf "WOV_PROJECT=\"$WOV_PROJECT\" "
  printf "WOV_KSTAGE=\"$WOV_KSTAGE\" "
  printf "WOV_GSTAGE=\"$WOV_GSTAGE\" "
  printf "WOV_STAGE=\"$WOV_STAGE\" "
  printf "WOV_PVER=\"$WOV_PVER\" "
  printf "WOV_SVER=\"$WOV_SVER\" "
  printf "WOV_USERNAME=\"$WOV_USERNAME\" "
  printf "WOV_USEREMAIL=\"$WOV_USEREMAIL\" "
  printf "WOV_PROJECT=\"$WOV_PROJECT\" "
  printf "WOV_PROJECTTYPE=\"$WOV_PROJECTTYPE\" "
  printf "WOV_PROJECTTITLE=\"$WOV_PROJECTTITLE\" "
  printf "WOV_PROJECTDESCRIPTION=\"$WOV_PROJECTDESCRIPTION\" "
  printf "WOV_KPROJECT=\"$WOV_KPROJECT\" "
  printf "WOV_WPROJECT=\"$WOV_WPROJECT\" "
  if [ "$RANCLUSTER" == "1" ]; then
    printf "CL_REGION=\"$CL_REGION\" "
    printf "CL_ZONES=\"${CL_ZONES}\" "
    printf "CL_VPC=\"${CL_VPC}\" "
  fi
}

# TODO: fill this function in, and remove from WIAAS
function fDoCluster()
{
  RANCLUSTER=1
  fConvertRegionCodeAWS ${WOV_REGION}
  CL_REGION=$cRC
  CL_ZONES="c d"
  CL_VPC=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=${WOV_CLUSTER}-vpc" --query 'Vpcs[0].VpcId' | ${SED} -e 's/^"//' -e 's/"$//')
  export CL_REGION
  export CL_ZONES
  export CL_VPC
}


function doPrintVarX()
{
  if [ "$HAS_SECRET" == "0" ]; then fBuildSecret; fi
  R=`doPrintVarsENVS | grep "$1=" | cut -f2 -d"=" | ${SED} -e "s/^'//" -e "s/'$//"`
  if [ "$R" == "" ]; then
    R=${!1}
  fi
  echo $R
}

function doPrintVarsENVS()
{
  if [ "$HAS_SECRET" == "0" ]; then fBuildSecret; fi

  cat ${WOV_SECRETFILE} |
    jq  -r 'walk( if type == "object" then with_entries(select( .key | test("STAGE.+") or test("//*") | not)) else . end) | [leaf_paths as $path | {"key": $path | join("_"), "value": getpath($path)}] | from_entries | keys[] as $k | "WOV_\($k)=" + @sh "\(.[$k])" '

  HAS_BUILDENV=1
}

function doPrintVarsCONF()
{
  doPrintVarsENVS | tr '\n' ' '
}

function doPrintVarsEXPORTS()
{
  if [ "$HAS_SECRET" == "0" ]; then fBuildSecret; fi

  cat ${WOV_SECRETFILE} |
    jq  -r 'walk( if type == "object" then with_entries(select( .key | test("STAGE.+") or test("//*") | not)) else . end) | [leaf_paths as $path | {"key": $path | join("_"), "value": getpath($path)}] | from_entries | keys[] as $k | "export WOV_\($k)=" + @sh "\(.[$k])" '

  HAS_BUILDENV=1
}



#function doLoadConf()
#{
#  CONFS=( $(cd ${WOV_BASEDIR}/wovtools/cache/conf/ && ls *.ck8s *.sk8s 2> /dev/null) )
#
#  for c in "${CONFS[@]}"; do
#    doCmd $c
#  done
#}
#function doLoadEnv()
#{
#  CONFS=( $(cd ${WOV_BASEDIR}/wovtools/cache/conf/ && ls *.ck8s *.sk8s 2> /dev/null) )
#
#  for c in "${CONFS[@]}"; do
#    doEnv $c
#  done
#}
function doLoadExports()
{
  CONFS=( $(cd ${WOV_BASEDIR}/wovtools/cache/conf/ && ls *.ck8s *.sk8s 2> /dev/null) )

  for c in "${CONFS[@]}"; do
    doExport $c
  done
}


#function doEnv() 
#{
#  if [ -e ${WOV_BASEDIR}/wovtools/cache/conf/${1} ]; then
#    cat ${WOV_BASEDIR}/wovtools/cache/conf/${1} | ${SED} -e 's/#.*$//' -e '/^\s*$/d'
#  else
#    echo
#    echo "ERROR: no environment file ${1} in cache."
#    echo
#    exit 1
#  fi
#}
#function doExport() 
#{
#  if [ -e ${WOV_BASEDIR}/wovtools/cache/conf/${1} ]; then
#    cat ${WOV_BASEDIR}/wovtools/cache/conf/${1} | ${SED} -e 's/#.*$//' | ${SED} -e '/^\s*$/d' | ${SED}  's/^/export &/'
#  else
#    echo
#    echo "ERROR: no environment file ${1} in cache."
#    echo
#    exit 1
#  fi
#}
#function doQCmd() 
#{
#  if [ -e ${WOV_BASEDIR}/wovtools/cache/conf/${1} ]; then
#    cat ${WOV_BASEDIR}/wovtools/cache/conf/${1} | ${SED} -e 's/#.*$//' -e '/^\s*$/d' -e 's/^/'"'"'/g' -e 's/$/'"'"'/g' | tr '\n' ' '
#  else
#    echo
#    echo "ERROR: no environment file ${1} in cache."
#    echo
#    exit 1
#  fi
#}
#
#function doCmd() 
#{
#  if [ -e ${WOV_BASEDIR}/wovtools/cache/conf/${1} ]; then
#    cat ${WOV_BASEDIR}/wovtools/cache/conf/${1} | ${SED} -e 's/#.*$//' -e '/^\s*$/d' | tr '\n' ' '
#  else
#    echo
#    echo "ERROR: no environment file ${1} in cache."
#    echo
#    exit 1
#  fi
#}
#
#function doStringLiteral() 
#{
#  if [ -e ${WOV_BASEDIR}/wovtools/cache/conf/${1} ]; then
#    cat ${WOV_BASEDIR}/wovtools/cache/conf/${1} | ${SED} -e 's/#.*$//' -e '/^$/d' -e 's/^/\$'"'"'/g' -e 's/$/'"'"'/g' | tr '\n' ' '
#  else
#    echo
#    echo "ERROR: no environment file ${1} in cache."
#    echo
#    exit 1
#  fi
#}

# ---------------------------------------------------------------------
function fConvertRegionCodeAWS()
{
  case $1 in
    va) cRC='us-east-1' ;;
    iad) cRC='us-east-1' ;;
    *)
      echo
      echo "***ERROR: unknown AWS region code of '$1'."
      exit 1
  esac
}


# --------------------------------------------------------------------- 
# Generate only the necessary env variables for microservices.
#  $1 - microservice name. ex. apisocket, apihal, etc.
#  $2 - "cm" or "se" for ConfigMap or Secrets
# NOTE: This works by calling a javscript or shell script that 
#   generates the env vars. This script must end in 'js' or 'sh' and
#   be in ${1}/src/${1}config* or src/${1}config*.
# --------------------------------------------------------------------- 
function fConfGeneration()
{

  # Read in envs
  if [ "${HAS_BUILDENV}" != "1" ]; then . <(doPrintVarsEXPORTS); fi

  # Get echo env vars, checking multiple locations
  if [ -e "${WOV_BASEDIR}/${1}/src/${1}config.js" ]; then
    local MSCFILE="${WOV_BASEDIR}/${1}/src/${1}config.js"
    if [ "$2" == "cm" ]; then   node -e "console.log((new (require('${MSCFILE}'))())._genK8SConfigMap())" ; 
    elif [ "$2" == "se" ]; then node -e "console.log((new (require('${MSCFILE}'))())._genK8SSecrets())" ; fi

  elif [ -e "${WOV_BASEDIR}/src/${1}config.js" ]; then
    local MSCFILE="${WOV_BASEDIR}/src/${1}config.js"
    if [ "$2" == "cm" ]; then   node -e "console.log((new (require('${MSCFILE}'))())._genK8SConfigMap())" ; 
    elif [ "$2" == "se" ]; then node -e "console.log((new (require('${MSCFILE}'))())._genK8SSecrets())" ; fi

  elif [ -e "${WOV_BASEDIR}/${1}/src/${1}config.sh" ]; then
    local MSCFILE="${WOV_BASEDIR}/${1}/src/${1}config.sh"
    ${MSCFILE} $2

  elif [ -e "${WOV_BASEDIR}/src/${1}config.sh" ]; then
    local MSCFILE="${WOV_BASEDIR}/src/${1}config.sh"
    ${MSCFILE} $2

  else
    (>&2 printf "\nERROR: could not find '${1}config.js'. Should be in ./src or ./${1}/src.\n\n")
    exit 1
  fi

}


# Toggle local and remote
# --------------------------------------------------------------------- 
#function doManageDevmode()
#{
#  if [ "$1" == "local" ] || [ "$1" == "remote" ]; then
#    cat ${WOV_BASEDIR}/wovtools/config.json | jq ".project.devmode=\"$1\"" > \
#       ${WOV_BASEDIR}/wovtools/.config.json.$$ && \
#       mv ${WOV_BASEDIR}/wovtools/.config.json.$$ \
#          ${WOV_BASEDIR}/wovtools/config.json
#    touch ${WOV_BASEDIR}/wovtools/secrets/*
#
#    # kill all port forwards
#    if [ -e "${WOV_BASEDIR}/wovtools/cache/.portforwards" ]; then
#      local PFPIDS=( $(cat ${WOV_BASEDIR}/wovtools/cache/.portforwards ) )
##      echo "PFPIDS ${PFPIDS}"
#      for p in "${PFPIDS[@]}"; do
#        ps -ef | grep "[k]ubectl port-forward" 2>&1 > /dev/null
#        if [ "$?" == "0" ]; then # found it
#          kill $p 2>/dev/null
#          echo "  ... killing port forward pid $p"
#        fi
#      done
#      rm ${WOV_BASEDIR}/wovtools/cache/.portforwards
#    fi
#
#    if [ -e ${WOV_BASEDIR}/wovtools/cmds/onDevmode${1^} ]; then
#      wov-cmd onDevmode${1^}
#    else
#      echo "  ... no 'onDevmode${1^}' command found (no worries)."
#    fi
#
#  fi
#
#}


# --------------------------------------------------------------------- 
# Command line processing
while [[ $1 =~ ^- ]]; do
  if [ "$1" == '-e' ] || [ "$1" == '--echo' ]; then
    ECHOMODE=1
  elif [ "$1" == '-E' ] || [ "$1" == '--bash-echo' ]; then
    ECHOMODE=2

  elif [ "$1" == '-c' ] || [ "$1" == '--cluster' ]; then
    fDoCluster

  elif [ "$1" == "--conf" ]; then
#    doLoadConf
    doPrintVarsCONF

  elif [ "$1" == "--envs" ]; then
#    doLoadEnv
    doPrintVarsENVS


    # print one var
  elif [ "$1" == "--env-var" ]; then
    shift
    command grep -h ${1} ${WOV_BASEDIR}/wovtools/cache/conf/*k8s | ${SED} -e 's/^.*[=]//' -e 's/^"//' -e 's/"$//'

  elif [ "$1" == "--exports" ]; then
#    doLoadExports
    doPrintVarsEXPORTS



#  elif [ "$1" == "--env" ]; then
#    shift
#    doEnv $1

#  elif [ "$1" == "--cmd" ]; then
#    shift
#    doCmd $1

#  elif [ "$1" == "--qcmd" ]; then
#    shift
#    doQCmd $1

#  elif [ "$1" == "--sl" ]; then
#    shift
#    doStringLiteral $1

#  elif [ "$1" == "--devmode" ]; then
#    shift
#    doManageDevmode $1

#  elif [ "$1" == "--local" ]; then
#    shift
#    doManageDevmode local

#  elif [ "$1" == "--remote" ]; then
#    shift
#    doManageDevmode remote

  elif [ "$1" == "--rcAWS" ]; then
    shift
    fConvertRegionCodeAWS $1
    echo "$cRC"
    shift

  elif [ "$1" == "--cm" ]; then
    shift
    fConfGeneration $1 cm

  elif [ "$1" == "--se" ]; then
    shift
    fConfGeneration $1 se

  elif [ "$1" == '--var' ]; then
    shift 
    V=$(doPrintVarX $1)
    if [ "$ECHOMODE" == "1" ]; then
      echo "$1=${V}"
    else
      echo ${V}
    fi
    DOALL=0
  elif [ "$1" == '-v' ] || [ "$1" == '--version' ]; then
    echo $WOV_VERSION

  elif [ "$1" == '--help' ] || [ "$1" == '-h' ]; then
    fDisplayOptions
    exit 0
  else
    echo
    echo "***ERROR: unknown option '$1'."
    echo
    exit 1
  fi
  shift
done

# if user never asked to show any individual variables, show all
if [ "$DOALL" == "1" ]; then
  if [ "$ECHOMODE" == "1" ]; then
    fDoEcho
  elif [ "$ECHOMODE" == "2" ]; then
    fDoBashEcho
  fi
fi
