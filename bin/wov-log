#!/usr/bin/env bash

DOECHO=1
FOLD=$(tput cols)
NAMESPACE=


# ---------------------------------------------------------------------
# ---------------------------------------------------------------------
function fDisplayOptions()
{
  cat <<EOF | fold -w ${FOLD} -s

usage: `basename $0` [options] {files ...}

This logs a pod, using a curses UI to select.

  -h                  : this help
  -q/-v               : quiet/verbose
  
  -n/--namespace/--ns : select another namespace


EOF
}



# ---------------------------------------------------------------------
# Handle Params
# ---------------------------------------------------------------------
while [[ $1 =~ ^- ]]; do

  if [ "$1" == "-q" ]; then
    shift
    DOECHO=0

  elif [ "$1" == "-v" ]; then
    shift
    DOECHO=2

  elif [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    fDisplayOptions
    exit 0

  elif [ "$1" == "-n" ] || [ "$1" == "--ns" ] || [ "$1" == "--namespace" ]; then
    shift
    NAMESPACE=" -n $1 "
    shift

  else
    echo
    echo "***ERROR: unknown option '$1'."
    echo
    fDisplayOptions
    exit 1
  fi
done




PODS=( $(kubectl get pods ${NAMESPACE} --no-headers=true) )
echo "PODS: ${PODS[@]}"

RL=""

i=0
while [ "$i" -lt "${#PODS[@]}" ]; do
  p_name=${PODS[$((0+$i))]}
  p_ready=${PODS[$((1+$i))]}
  p_status=${PODS[$((2+$i))]}
  p_restarts=${PODS[$((3+$i))]}
  p_age=${PODS[$((4+$i))]}

#  printf "  pod      : ${p_name}\n" printf "  ready    : ${p_ready}\n" printf "  status   : ${p_status}\n" printf "  restarts : ${p_restarts}\n" printf "  age      : ${p_age}\n\n"
  # RL+=" ${p_name} '${p_ready}_${p_status}_${p_restarts}_${p_age}' OFF "
  RL+=" ${p_name} '${p_ready}_${p_status}_${p_restarts}_${p_age}' "

  i=$(($i+5))
done

# exec 3>&1; result=$(dialog --keep-tite --title 'Log Pod' --radiolist 'Select a pod to log' 15 80 6 ${RL} 2>&1 1>&3); ret=$? ; exec 3>&-
exec 3>&1; result=$(dialog --keep-tite --title 'Log Pod' --menu 'Select a pod to log' 15 80 6 ${RL} 2>&1 1>&3); ret=$? ; exec 3>&-
if [ "$ret" == "0" ]; then
  kubectl ${NAMESPACE} describe pod $result
  kubectl ${NAMESPACE} logs -f $result
else
  exit $ret
fi
