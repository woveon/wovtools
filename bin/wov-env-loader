#!/usr/bin/env bash

# --------------------------------------------------------------------- 
# This is a light-weight env variable loader. Used by wov-env and wov-env-build.
# --------------------------------------------------------------------- 


# --------------------------------------------------------------------- 
# Versions
# --------------------------------------------------------------------- 
export WOV_VERSION=1
export WOV_VH_VERSION=0.1

# --------------------------------------------------------------------- 
# Command line
# --------------------------------------------------------------------- 
if [ "$1" == '-g' ] || [ "$1" == '--global' ]; then shift; GLOBALCOMMAND=$1; shift; fi
if [ "$1" == "--vh-label" ]; then echo "${WOV_VH_VERSION}"; exit 0; fi

# --------------------------------------------------------------------- 
# git vars
# --------------------------------------------------------------------- 
export WOV_BASEDIR="$(git rev-parse --show-toplevel)"
if [      "$WOV_BASEDIR" == "" ]; then echo "ERROR: not in wovtools project (no git)."; exit 1; fi
if [ ! -d "$WOV_BASEDIR/wovtools" ]; then echo "ERROR: not in wovtools project (no wovtools directory)."; exit 1; fi
if [ ! -f "${WOV_BASEDIR}/wovtools/config.json" ]; then echo "ERROR: not in wovtools project (no wovtools/config.json file)."; exit 1; fi
export WOV_PVER="$(git rev-list --count $(git rev-parse --abbrev-ref HEAD))"
export WOV_SVER="$(cd ${WOV_BASEDIR}/wovtools/secrets && git rev-list --count $(git rev-parse --abbrev-ref HEAD))"
export WOV_USERNAME="$(git config user.name)"
export WOV_USEREMAIL="$(git config user.email)"
export WOV_GSTAGE="$(git rev-parse --abbrev-ref HEAD)"


# --------------------------------------------------------------------- 
# Source files for project configuration : build if needed
# --------------------------------------------------------------------- 
export WOV_CACHEDIR="${WOV_BASEDIR}/wovtools/cache"
export WOV_CONFIGFILE_RAW="${WOV_BASEDIR}/wovtools/config.json"
export WOV_CONFIGFILE_LOCALRAW="${WOV_BASEDIR}/wovtools/local.json"
export WOV_CONFIGFILE_MERGED="${WOV_CACHEDIR}/.merged.json"
#export WOV_FILE_SECRETS_RAW="${WOV_BASEDIR}/wovtools/config.json"
#export WOV_FILE_SECRETSLOCAL_RAW="${WOV_BASEDIR}/wovtools/local.json"
#export WOV_FILE_SECRETSMERGED="${WOV_CACHEDIR}/.merged.json"


# --------------------------------------------------------------------- 
# global .wovtools file
# --------------------------------------------------------------------- 
export WOV_ME=$(cat ${HOME}/.wovtools | jq -r '.me')
if [ "${WOV_ME}" == "null" ] ; then
  printf "\n\nERROR: You need to set 'me' in the wovtools/config.json file.\n"
  printf "  - This is a unique code in this project, to represent yourself. Try using your initials (assuming they are unique to your team).\n\n"
  exit 1
fi

# --------------------------------------------------------------------- 
# vars from merged files (config.json and local.json)
# --------------------------------------------------------------------- 

# --------------------------------------------------------------------- 
# Merge if out of date
if [ ${WOV_CONFIGFILE_RAW} -nt ${WOV_CONFIGFILE_MERGED} ] || [ ${WOV_CONFIGFILE_LOCALRAW} -nt ${WOV_CONFIGFILE_MERGED} ]; then
  echo "... merged file out of date, creating: ${WOV_CONFIGFILE_MERGED}"
  echo "" > ${WOV_CONFIGFILE_MERGED}
  chmod 600 ${WOV_CONFIGFILE_MERGED}
  jq -s ".[0] * .[1]" ${WOV_CONFIGFILE_RAW} ${WOV_CONFIGFILE_LOCALRAW} >> ${WOV_CONFIGFILE_MERGED} 2> /dev/null
  if [ "$?" != "0" ]; then
    F1=$(cat ${WOV_CONFIGFILE_RAW} | jq type 2>&1)
    F1a=$?
    if [ "$F1a" != "0" ]; then printf "\n\nERROR: ${WOV_CONFIGFILE_RAW} is not properly formatted.\n${F1}\n\n"; fi
    F2=$(cat ${WOV_CONFIGFILE_LOCALRAW} | jq type 2>&1)
    F2a=$?
    if [ "$F2a" != "0" ]; then printf "\n\nERROR: ${WOV_CONFIGFILE_LOCALRAW} is not properly formatted.\n${F2}\n\n"; fi
    exit 1;
  fi
fi


# --------------------------------------------------------------------- 
# Load merged file in one call
MERGEDVARS=()
while read f; do
  MERGEDVARS+=( "$f" )
done <<<$(cat ${WOV_CONFIGFILE_MERGED} | jq -r ". | ( .ver, .project.project, .project.type, .project.title, .project.description, .archive.repository, .archive.env  )" )
WOV_PVERSION=${MERGEDVARS[0]}
if [ "${WOV_PVERSION}" != "${WOV_VERSION}" ] && [ "${WOV_PVERSION}" != "initing" ] ; then
  printf "\n\nERROR: Your project version '${WOV_PVERSION}', does not match to the WovTools version '${WOV_VERSION}'.\n\n"
  exit 1
fi
export WOV_WPROJECT="${MERGEDVARS[1]}"
export WOV_PROJECTTYPE="${MERGEDVARS[2]}"
export WOV_PROJECTTITLE="${MERGEDVARS[3]}"
export WOV_PROJECTDESCRIPTION="${MERGEDVARS[4]}"
export WOV_ARCHIVEREPOSITORY="${MERGEDVARS[5]}"
export WOV_ARCHIVEENV="${MERGEDVARS[6]}"


# vars from Kubernetes
# --------------------------------------------------------------------- 
if [ "$GLOBALCOMMAND" != "" ]; then 
  export WOV_CONTEXT=$GLOBALCOMMAND; 
else
  export WOV_CONTEXT="$(kubectl config current-context)"
fi
OLDIFS=$IFS
IFS='-'
array=( $WOV_CONTEXT )
IFS=$OLDIFS
export WOV_KSTAGE="${array[5]}"
export WOV_KPROJECT="${array[4]}"
export WOV_NS="${WOV_KPROJECT}-${WOV_KSTAGE}"
export WOV_FLAVOR="${array[3]}"
export WOV_REGION="${array[2]}"
export WOV_PROVIDER="${array[1]}"
export WOV_CLTYPE="${array[0]}"
export WOV_CLUSTER="${WOV_CLTYPE}-${WOV_PROVIDER}-${WOV_REGION}-${WOV_FLAVOR}"
if [ "${#array[@]}" != "6" ]; then
  # error if no namespace nad not in global context
  if [ "${GLOBALCOMMAND}" == "" ]; then
    echo "ERROR: bad context '${WOV_CONTEXT}' (from '-g X' switch or kubectl config current-context). Should be CLTYPE-PROVIDER-REGION-FLAVOR-PROJECT-STAGE."
    exit 1
  fi
fi



# --------------------------------------------------------------------- 
# Unifying
# --------------------------------------------------------------------- 
export WOV_STAGE="$WOV_KSTAGE"        # KSTAGE has priority since git repo might differ but want to build for current stage.
export WOV_PROJECT="${WOV_WPROJECT}"  

# echo "PROJECT ${WOV_PROJECT} KSTAGE ${WOV_KSTAGE}"
