#!/usr/bin/env bash

FOLD=$(tput cols)
DOECHO=1
HAS_SECRET=0
HAS_BUILDENV=0
HAS_CLEAN=0
SECRETDIFF=1
DONSIGNORE=0


# --------------------------------------------------------------------- 
# --------------------------------------------------------------------- 
function fDisplayOptions()
{
  cat <<EOF | fold -w ${FOLD} -s


usage: `basename $0` [options]

Builds the environment information of a WovTools distribution. Specifically, the environment variables and K8s ConfigMap and Secrets.

  -q : quiet
  -v : verbose
  -l : use local variables in build
  -s : build the secret file
  -e : build the environment files (-s assumed)
  --clean : cleans the cache

Stage Modifiers:
Developing locally requires port forwarding to the cluster, but also changes to configuration so that your code connects to local ports an hosts, as opposed to what it would try in the cluster. 

EOF
}
if [ "$1" == '--help' ] || [ "$1" == '-h' ]; then fDisplayOptions; exit 0; fi



# --------------------------------------------------------------------- 
# Import Env 
# --------------------------------------------------------------------- 
buildargs=( "$@" )
set ""
. wov-env
#. wov-ns-check
set -- "${buildargs[@]}"


# --------------------------------------------------------------------- 
# vars
# --------------------------------------------------------------------- 
SECRET_CACHE_DIR=${WOV_BASEDIR}/wovtools/cache/secrets
SECRETFILE=${SECRET_CACHE_DIR}/current.json
SECRETFILELAST=${SECRET_CACHE_DIR}/last.json
SECRETMODFILE=
SECRETMODFILELAST=



# --------------------------------------------------------------------- 
# Generates the 
# --------------------------------------------------------------------- 
function fBuildSecret()
{

  # ---------------------------------------------------------------------
  # Read config for SECRETFILES
  # ---------------------------------------------------------------------
  local SECRETFILES=( $(jq -r ".secrets.${WOV_STAGE}[] " ${WOV_BASEDIR}/wovtools/config.json 2> /dev/null) )
  if [ "$?" != "0" ]; then
    printf "\n\nERROR: no entry for stage '${WOV_STAGE}' in config.json file '.secrets'.\n"
    printf "  - You probably just need to create an entry, similar to the other stages.\n\n"
    exit 1
  fi
  # echo "SECRETFILES=${SECRETFILES[*]}"


  # Build secret file
  # ---------------------------------------------------------------------
  if [ "$DOECHO" == "2" ]; then echo "SECRETFILE=${SECRETFILE}"; fi

  # create dir, file, and remove prying eyes...
  mkdir -p ${SECRET_CACHE_DIR}
  chmod 600 ${SECRETFILE}

  # start with abbreviated versions of "basic config"
  cat > ${SECRETFILE} <<EOF
{
  "CONTEXT"  : "${K8S_CONTEXT}",
  "CLUSTER"  : "${WOV_CLUSTER}",
  "CLTYPE"   : "${WOV_CLTYPE}",
  "PROVIDER" : "${WOV_PROVIDER}",
  "REGION"   : "${WOV_REGION}",
  "FLAVOR"   : "${WOV_FLAVOR}",
  "NS"       : "${WOV_NS}",
  "PROJECT"  : "${WOV_PROJECT}",
  "STAGE"    : "${WOV_STAGE}",
  "ME"       : "${WOV_ME}",

  "PROJECT"            : "${WOV_PROJECT}",
  "PROJECTTYPE"        : "${WOV_PROJECTTYPE}",
  "PROJECTTITLE"       : "${WOV_PROJECTTITLE}",
  "PROJECTDESCRIPTION" : "${WOV_PROJECTDESCRIPTION}",

  "ARCHIVEREPOSITORY" : "${WOV_ARCHIVEREPOSITORY}",
  "ARCHIVEENV"        : "${WOV_ARCHIVEENV}",

  "USERNAME"  : "${WOV_USERNAME}",
  "USEREMAIL" : "${WOV_USEREMAIL}",

  "PVER" : "${WOV_PVER}",
  "SVER" : "${WOV_SVER}",

  "//LBL"   : "Chose stage then pver so user doing a lot of commits won't bury production images when listing.",
  "LBL_SRC" : "${WOV_STAGE}_${WOV_PVER}",
  "LBL_ENV" : "${WOV_STAGE}_${WOV_PVER}_${WOV_SVER}"
}
EOF

  # Check for source file existence
  for sf in ${SECRETFILES[*]}; do
    if [ ! -e ${WOV_BASEDIR}/wovtools/secrets/$sf ]; then
      printf "\n\nERROR: file for secret build does not exist: 'wovtools/secrets/$sf'.\n"
      exit 1
    fi
  done


  # STEP 0: merge files in order
  for sf in ${SECRETFILES[*]}; do
    if [ "$DOECHO" == "2" ]; then echo "  ... adding secret file $sf"; fi
    jq -s ".[0] * .[1]" ${SECRETFILE} ${WOV_BASEDIR}/wovtools/secrets/$sf >> ${SECRETFILE}.1
    mv ${SECRETFILE}.1 ${SECRETFILE}
  done


  # STEP 1: Grafting
  # - get mods that are 'on'
  SMODS=$(jq -r '.stagemods[] | select(.status == "on") | .["name"]' ${WOV_BASEDIR}/wovtools/config.json)
  #echo "SMODS: ${SMODS}"
  # for each mod
  for m in ${SMODS[*]}; do
    #echo "m: $m"
    # get routes
    rts=( $(jq -r '.stagemods[] | select(.name == "'"${m}"'") | .routes[] | "\(.[0]) \(.[1])"' ${WOV_BASEDIR}/wovtools/config.json) )
    # echo "rts: ${#rts[@]} ${rts[@]}"
    while [[ "${#rts[@]}" != "0" ]]; do
      rtfrom=${rts[0]}
      rtto=${rts[1]}
      rts=( "${rts[@]:2}" ) # shift twice
      #echo "rt: ${rtfrom} -> ${rtto}"
      # rewrite any ME->STAGE in route
      rtto=$(echo $rtto | sed "s/ME/${WOV_STAGE}/")
      #echo "rt: ${rtfrom} -> ${rtto}"

      # rewrite routes in SECRETFILE, remove original graft, then move back to SECREFILE for next mod
      jq '.'"${rtto}"' += .'"${rtfrom}"'' ${SECRETFILE} >> ${SECRETFILE}.1
      # TODO: remove original graft

      # mv file
      mv ${SECRETFILE}.1 ${SECRETFILE}
    done
  done

  # STEP 2: STAGE Select
  # - concat child attributes into parent that are prefixed by STAGEx, where x is your stage
  # cat ${SECRETFILE}
  wov_stage-select ${SECRETFILE} STAGE${WOV_STAGE} > ${SECRETFILE}.1
  mv ${SECRETFILE}.1  ${SECRETFILE}

  # Is secret different from last run?
  # By default, is 1
  if [ -e "${SECRETFILELAST}" ]; then
    if [ "`diff ${SECRETFILE} ${SECRETFILELAST} && echo $?`" == "0" ]; then
      SECRETDIFF=0
        # --- no diff so turn this off
    fi
  fi


  # mark as secret being updated
  HAS_SECRET=1

  if [ "$DOECHO" == "2" ]; then
    echo "... SECRETDIFF=${SECRETDIFF}";
  elif [ "$DOECHO" == "1" ] && [ "$SECRETDIFF" == "1" ]; then
    echo "... secret needs to be (re)built."
  fi

}



# --------------------------------------------------------------------- 
# --------------------------------------------------------------------- 
function fCleanCacheAll() 
{
  HAS_CLEAN=1
  _fCleanCache "conf" "k8s" "secret"
}
function fCleanK8SConf()
{
  _fCleanCache "k8s"
}
function fCleanCacheConf()
{
  _fCleanCache "conf"
}
function _fCleanCache() 
{
  BUILDDIRS=( "$*" )
  for f in ${BUILDDIRS[@]}; do
    DEST=${WOV_BASEDIR}/wovtools/cache/$f
    if [ $DOECHO -ge 2 ]; then echo "  ... clean cache in dir '${DEST}'."; fi
    rm -fR ${DEST}/* || true
  done
}



# --------------------------------------------------------------------- 
# --------------------------------------------------------------------- 
function fBuildEnv()
{
  if [ "$HAS_SECRET" == "0" ]; then fBuildSecret; fi

  mkdir -p ${WOV_BASEDIR}/wovtools/cache/conf
  mkdir -p ${WOV_BASEDIR}/wovtools/cache/k8s
  chmod 700 ${WOV_BASEDIR}/wovtools/cache


  # build conf (and if stagemod, do that as well)
  fCleanCacheConf
  fBuildEnvDir conf conf ${SECRETFILE}

  # build k8s (no stagemod (will I regret this?... dunno))
  fCleanK8SConf
  fBuildEnvDir k8s k8s ${SECRETFILE}

  # mark as done
  HAS_BUILDENV=1

  # Update secret since it was used
  cp ${SECRETFILE} ${SECRETFILELAST}
}


# --------------------------------------------------------------------- 
# build all .wov files 
#   from ${WOV_BASEDIR}/wovtools/$1 
#     to ${WOV_BASEDIR}/wovtools/cache/$2
# --------------------------------------------------------------------- 
fBuildEnvDir()
{

  mkdir -p ${WOV_BASEDIR}/wovtools/cache/$2
  DEST=${WOV_BASEDIR}/wovtools/cache/$2/${f%.wov}

  # Find src files to compile
  WOVFILES=$(cd ${WOV_BASEDIR}/wovtools/$1; ls *.wov 2> /dev/null)
  if [ "${WOVFILES}" == "" ]; then echo "  ... no files found in wovtools/$1/*.wov."; fi

  # Compile them
  for f in ${WOVFILES}; do

    SRC=${WOV_BASEDIR}/wovtools/$1/${f}
    DEST=${WOV_BASEDIR}/wovtools/cache/$2/${f%.wov}
    USESECRET=$3

    # check if need to compile
    if [ "${SRC}" -nt "${DEST}" ] || [ "$SECRETDIFF" == "1" ]; then
      if [ "$DOECHO" == "2" ] || [ "$DOECHO" == "2" ]; then echo "  ... build ${SRC}"; fi
      #echo " --- `basename ${DEST}` needs to be built"
#      echo "SHOULD CALL: wov-compile ${SECRETFILE} ${SRC} > ${DEST}"
      wov-compile ${USESECRET} ${SRC} > ${DEST}
    else
      if [ "$DOECHO" == "2" ]; then echo "  ... skipping ${SRC}"; fi
    fi
  done


}



# --------------------------------------------------------------------- 
# Handle Params
# --------------------------------------------------------------------- 
while [[ $1 =~ ^- ]]; do
#  echo "param '$1'"

  if [ "$1" == "-q" ]; then
    shift
    DOECHO=0

  elif [ "$1" == "-i" ]; then
    shift
    DONSIGNORE=1

  elif [ "$1" == "-v" ]; then
    shift
    DOECHO=2

  elif [ "$1" == "-s" ]; then
    shift
    if [ "$DONSIGNORE" == "0" ]; then
      buildargs=( "$@" )
      set ""
      . wov-ns-check
      set -- "${buildargs[@]}"
    fi
    fBuildSecret

  elif [ "$1" == "-e" ]; then
    shift
    if [ "$DONSIGNORE" == "0" ]; then
      buildargs=( "$@" )
      set ""
      . wov-ns-check
      set -- "${buildargs[@]}"
    fi
    fBuildEnv

  elif [ "$1" == "--clean" ]; then
    shift
    _fCleanCacheAll

  elif [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    fDisplayOptions
    exit 0

  else
    echo
    echo "***ERROR: unknown option '$1'."
    echo
    fDisplayOptions
    exit 1
  fi
done


if [ ${HAS_SECRET} -eq 0 ] && [ ${HAS_BUILDENV} -eq 0 ] && [ ${HAS_CLEAN} -eq 0 ]; then
  echo
  echo "ERROR: no command passed."
  echo
  fDisplayOptions
  exit 1
fi
