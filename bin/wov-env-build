#!/usr/bin/env bash

FOLD=`tput cols`
DOECHO=1
HAS_SECRET=0
HAS_CLEAN=0
HAS_BUILDENV=0
#DONSIGNORE=0
DOFORCE=0
LOCALCONTEXT=
GLOBALCOMMAND=
FORCEDNS=
  # -- Can force this to be a namespace instead of from git/K8s

CONFEXT=
  # see wov-push-k8s


# --------------------------------------------------------------------- 
# --------------------------------------------------------------------- 
function fWovEnvBuildDisplayOptions()
{
  cat <<EOF | fold -w ${FOLD} -s


usage: `basename $0` [options]

Builds WovTool configurations for secrets (-s) and clusters (-c) (K8s, ConfigMap and Secrets). By default, clusters are any 'on' secrets mods, the 'localcontext' (in the wovtools/local.json file) and current context from CLUSTER and STAGE settings.


  Leading Commands - Must be placed first
  -g/--global X  : set global context (ignores K8s context) (TODO FIX: redundant with secrets and cluster X)
  -n/--namespace : override namespace
  -h/--help      : list this help


  Modifying Commands
  -q             : quiet
  -v             : verbose (and leaves intermediate files in cache/cluster )
  --clean        : cleans the cache
  -f/--force     : force build of secrets and cluster


  Commands
  -s/--secrets X : build secrets for cluster X
  -c/--cluster X : build the secret and Kubernetes files for cluster X
  --local        : build local secrets



EOF
}


# --------------------------------------------------------------------- 
# Leading commands:
# --------------------------------------------------------------------- 


LEADINGCOMMANDS=1
while [ "$LEADINGCOMMANDS" == "1" ]; do
  if [ "$1" == '--help' ] || [ "$1" == '-h' ]; then fWovEnvBuildDisplayOptions; exit 0; 

  elif [ "$1" == '--global' ] || [ "$1" == '-g' ]; then 
    shift; 
    export GLOBALCOMMAND="$1";
    shift; 

  elif [ "$1" == '--namespace' ] || [ "$1" == '-n' ]; then 
    shift; 
    FORCEDNS=$1
    shift;

  else
    LEADINGCOMMANDS=0
  fi
done


# --------------------------------------------------------------------- 
# Import Env 
# --------------------------------------------------------------------- 
envbuildargs=( "$@" )
set ""
. wov-env-loader
set -- "${envbuildargs[@]}"

# --------------------------------------------------------------------- 
# --------------------------------------------------------------------- 




# --------------------------------------------------------------------- 
# Namespace - global, forced or normal (from git/K8s)
# --------------------------------------------------------------------- 

# Global namespace
if [ "$GLOBALCOMMAND" != "" ]; then
  export WOV_PROJECT="global"
  export WOV_STAGE="global"

# Forced namespace
elif [ "${FORCEDNS}" != "" ]; then
  IFS='-' read -r -a array <<< "${FORCEDNS}"
  #echo "array : ${array[@]}"
  #echo "here - shifting namespace to ${FORCEDNS}, from ${WOV_NAMESPACE} ${WOV_NS} ${WOV_STAGE}"
  export WOV_NS="${array[0]}-${array[1]}"
  export WOV_PROJECT="${array[0]}"
  export WOV_STAGE="${array[1]}"

# Namespace from K8s/Git
else
  wov-ns-check
  if [ "$?" != "0" ]; then
    if [ "${WOV_KPROJECT}" != "${WOV_WPROJECT}" ]; then
      printf "ERROR: WOV_KPROJECT/WOV_WPROJECT differences need to be fixed.\n\n"
      exit 1
    elif [ "${WOV_KSTAGE}" != "${WOV_GSTAGE}" ]; then
      printf "WARNING: WOV_KSTAGE/WOV_GSTAGE differ. Assuming Kubernetes ${WOV_KSTAGE} and continuing (Allows building when git branches differ).\n\n"
    else
      printf "ERROR: Unknown namespace differences. Needs to be fixed.\n\n"
      printf "WOV_PROJECT/KPROJECT/WPROJECT: '${WOV_PROJECT}' '${WOV_KPROJECT}' '${WOV_WPROJECT}'\n"
      printf "WOV_STAGE/KSTAGE/GSTAGE      : '${WOV_STAGE}' '${WOV_KSTAGE}' '${WOV_GSTAGE}'\n"
      exit 1
    fi
  fi
fi

# --------------------------------------------------------------------- 
# vars - NOTE: moved to wov-env
# --------------------------------------------------------------------- 
#WOV_CACHEDIR=${WOV_BASEDIR}/wovtools/cache
#SECRETSFILE_RAW=${WOV_BASEDIR}/wovtools/config.json
#SECRETSFILELOCAL_RAW=${WOV_BASEDIR}/wovtools/local.json
#SECRETSFILEMERGED_RAW=${WOV_CACHEDIR}/.merged.json

#SECRETFILE_BASE=${WOV_CACHEDIR}/current
#SECRETFILELAST_BASE=${WOV_CACHEDIR}/last


# --------------------------------------------------------------------- 
# Ensure the WOV_CACHEDIR exists and is protected and then merge
# files config.json and local.json together in SECRETSFILEMERGED_RAW 
# if they have changed.
# --------------------------------------------------------------------- 
#mkdir -p ${WOV_CACHEDIR}
#chmod -R 700 ${WOV_CACHEDIR}
#if [ ${SECRETSFILE_RAW} -nt ${SECRETSFILEMERGED_RAW} ] || [ ${SECRETSFILELOCAL_RAW} -nt ${SECRETSFILEMERGED_RAW} ]; then
#  echo "... merged file out of date, creating: ${SECRETSFILEMERGED_RAW}"
#  echo "" > ${SECRETSFILEMERGED_RAW}
#  chmod 600 ${SECRETSFILEMERGED_RAW}
#  jq -s ".[0] * .[1]" ${SECRETSFILE_RAW} ${SECRETSFILELOCAL_RAW} >> ${SECRETSFILEMERGED_RAW}
#fi


# --------------------------------------------------------------------- 
# Creates the local context secrets.json file
# --------------------------------------------------------------------- 
function fBuildLocalSecrets()
{
  retreiveLocalContextCluster
  fBuildSecrets $LOCALCONTEXT
}


# --------------------------------------------------------------------- 
# Store the local context cluster (from merged raw file) in $LOCALCONTEXT
# --------------------------------------------------------------------- 
function retreiveLocalContextCluster()
{ if [ "${LOCALCONTEXT}" == "" ]; then LOCALCONTEXT=`jq -r ".localcontext" ${WOV_CONFIGFILE_MERGED}`; fi }


# --------------------------------------------------------------------- 
# Generates the secrets for a cluster
#  wovtools/cache/secrets/current_X.json
# --------------------------------------------------------------------- 
function fBuildSecrets()
{
  # if verbose, keep intermediate files for debugging
  local MV=mv
  if [ "$DOECHO" == "2" ]; then MV=cp; fi

  local CLUSTER=$1
  if [ "$CLUSTER" == "" ]; then printf "\n\nERROR: no CLUSTER defined for building secret.\n\n"; exit 1; fi

  local CLUSTER_DIR="${WOV_CACHEDIR}/clusters/${CLUSTER}"
  mkdir -p ${CLUSTER_DIR}
  chmod -R 700 ${CLUSTER_DIR}

  local SECRETFILE="${CLUSTER_DIR}/secrets.json"
  local SECRETFILELAST="${CLUSTER_DIR}/.last.json"

  if [ "$DOECHO" == "2" ]; then echo "CLUSTER=${CLUSTER}"; fi
  if [ "$DOECHO" == "2" ]; then echo "SECRETFILE=${SECRETFILE}"; fi

  # Read the source secrets files from WOV_CONFIGFILE_MERGED , to 
  # generate the SECRETFILE for the CLUSTER.
  # ---------------------------------------------------------------------
  local SRCSECRETFILES=( $(jq -r ".secrets.${WOV_STAGE}[] " ${WOV_CONFIGFILE_MERGED} 2> /dev/null) )
  if [ "$?" != "0" ] || [ "${#SRCSECRETFILES}" == "0" ]; then
    printf "\n\nERROR: either no entry or no files for stage '${WOV_STAGE}' in config.json file '.secrets'.\n"
    printf "  - You probably just need to create an entry in wovtools/config|local.json, similar to the other stages.\n\n"
    exit 1
  fi



  # ---------------------------------------------------------------------
  # Build temp secret file
  # ---------------------------------------------------------------------
  echo "" > ${SECRETFILE}_
  chmod 600 ${SECRETFILE}_

  # start with abbreviated versions of "basic config"
  cat >> ${SECRETFILE}_ <<EOF
{
  "CONTEXT"  : "${WOV_CONTEXT}",
  "CLUSTER"  : "${WOV_CLUSTER}",
  "CLTYPE"   : "${WOV_CLTYPE}",
  "PROVIDER" : "${WOV_PROVIDER}",
  "REGION"   : "${WOV_REGION}",
  "FLAVOR"   : "${WOV_FLAVOR}",
  "NS"       : "${WOV_NS}",
  "PROJECT"  : "${WOV_PROJECT}",
  "STAGE"    : "${WOV_STAGE}",
  "ME"       : "${WOV_ME}",

  "PROJECT"            : "${WOV_PROJECT}",
  "PROJECTTYPE"        : "${WOV_PROJECTTYPE}",
  "PROJECTTITLE"       : "${WOV_PROJECTTITLE}",
  "PROJECTDESCRIPTION" : "${WOV_PROJECTDESCRIPTION}",

  "ARCHIVEREPOSITORY" : "${WOV_ARCHIVEREPOSITORY}",
  "ARCHIVEENV"        : "${WOV_ARCHIVEENV}",

  "USERNAME"  : "${WOV_USERNAME}",
  "USEREMAIL" : "${WOV_USEREMAIL}",

  "PVER" : "${WOV_PVER}",
  "SVER" : "${WOV_SVER}",

  "//LBL"   : "Chose stage then pver so user doing a lot of commits won't bury production images when listing.",
  "LBL_SRC" : "${WOV_STAGE}_${WOV_PVER}",
  "LBL_ENV" : "${WOV_STAGE}_${WOV_PVER}_${WOV_SVER}"
}
EOF

  # STEP 1: Check for source file existence
  for sf in ${SRCSECRETFILES[*]}; do
    echo "looking for ${WOV_BASEDIR}/wovtools/secrets/$sf"
    if [ ! -e ${WOV_BASEDIR}/wovtools/secrets/$sf ]; then
      printf "\n\nERROR: file for secret build does not exist: 'wovtools/secrets/$sf'.\n"
      exit 1
    fi
  done


  # STEP 2: merge src secret files files in order
  for sf in ${SRCSECRETFILES[*]}; do
    if [ "$DOECHO" == "2" ]; then echo "  ... adding secret file $sf"; fi
    echo "" > ${SECRETFILE}.2
    chmod 600 ${SECRETFILE}.2
    jq -s ".[0] * .[1]" ${SECRETFILE}_ ${WOV_BASEDIR}/wovtools/secrets/$sf >> ${SECRETFILE}.2
    ${MV} ${SECRETFILE}.2 ${SECRETFILE}_
  done


  # STEP 3: CLUSTER Select
  # - concat child attributes into parent that are prefixed by CLUSTERx, where x is your CLUSTER
  echo "" > ${SECRETFILE}.3
  chmod 600 ${SECRETFILE}.3
  if [[ $DOECHO -ge 1 ]]; then   echo "  ... using cluster     : ${CLUSTER}"; fi
  wov_stage-select ${SECRETFILE}_ CLUSTER ${CLUSTER} >> ${SECRETFILE}.3
  if [ "$?" != "0" ]; then exit 1; fi
  ${MV} ${SECRETFILE}.3  ${SECRETFILE}_


  # STEP 4: STAGE Select
  # - concat child attributes into parent that are prefixed by STAGEx, where x is your stage
  # cat ${SECRETFILE}
  echo "" > ${SECRETFILE}.4
  chmod 600 ${SECRETFILE}.4
  if [[ $DOECHO -ge 1 ]]; then   echo "  ... using stage       : ${WOV_STAGE}"; fi
  wov_stage-select ${SECRETFILE}_ STAGE ${WOV_STAGE} >> ${SECRETFILE}.4
  if [ "$?" != "0" ]; then exit 1; fi
  ${MV} ${SECRETFILE}.4  ${SECRETFILE}_


  # STEP 5: Secrets Mods for a cluster (from wovtools/config.json|local.json), which applies modifications for a cluster to MERGED_RAW data
  #       : NOTE: also any STAGEME is converted to the WOV_ME variable stage
  # get routes
  local clusterentry=`jq -r '.secretsmods.'"${CLUSTER}"  ${WOV_CONFIGFILE_MERGED} 2> /dev/null` 
  if [ "${clusterentry}" != "null" ]; then
    if [[ $DOECHO -ge 1 ]]; then echo "  ... using secretsmods : ${CLUSTER}"; fi

    local rts=( $(jq -r '.secretsmods.'"${CLUSTER}"' | .routes[] | "\(.[0]) \(.[1])"' ${WOV_CONFIGFILE_MERGED} 2> /dev/null ) )
    # echo "rts: ${#rts[@]} ${rts[@]}"

    # NOTE: doing this in order of entries
    while [[ "${#rts[@]}" != "0" ]]; do
      rtfrom=${rts[0]}
      rtto=${rts[1]}
      rts=( "${rts[@]:2}" ) # shift twice
      #echo "rt: ${rtfrom} -> ${rtto}"
      # rewrite any ME->STAGE in route
      rtto=$(echo $rtto | sed "s/ME/${WOV_STAGE}/")
      # echo "rt: ${rtfrom} -> ${rtto}"

      # rewrite routes in SECRETFILE, remove original graft, then move back to SECREFILE for next mod
      echo "" > ${SECRETFILE}.5
      chmod 600 ${SECRETFILE}.5
      jq '.'"${rtto}"' += .'"${rtfrom}"'' ${SECRETFILE}_ >> ${SECRETFILE}.5
      # TODO: remove original graft

      # mv file
      ${MV} ${SECRETFILE}.5 ${SECRETFILE}_
    done


    # use SECRETFILE if no SECRETFILE or differs from SECRETFILE_. otherwise just delete.
#    if [ ! -f ${SECRETFILE} ]; then mv ${SECRETFILE}_ ${SECRETFILE};
#    else 
#      diff ${SECRETFILE}_ ${SECRETFILE} > /dev/null
#      if [ "$?" != "0" ]; then mv ${SECRETFILE}_ ${SECRETFILE}; 
#      else rm ${SECRETFILE}_; fi
#    fi

  else
    if [ "$DOECHO" == "2" ]; then echo "  ... no secretsmods entry for cluster: ${CLUSTER}"; fi
#    ${MV} ${SECRETFILE}_  ${SECRETFILE}
  fi


  # STEP 6&7: Clean CLUSTER and STAGE from the raw code. Have to do it after the mods above since those
  #           can rewrite CLUSTER over STAGE.
  echo "" > ${SECRETFILE}.6
  chmod 600 ${SECRETFILE}.6
  wov_stage-select ${SECRETFILE}_ CLUSTER ${CLUSTER} clean >> ${SECRETFILE}.6
  if [ "$?" != "0" ]; then exit 1; fi
  ${MV} ${SECRETFILE}.6  ${SECRETFILE}_

  echo "" > ${SECRETFILE}.7
  chmod 600 ${SECRETFILE}.7
  wov_stage-select ${SECRETFILE}_ STAGE ${WOV_STAGE} clean >> ${SECRETFILE}.7
  ${MV} ${SECRETFILE}.7  ${SECRETFILE}_


  # FINAL: move it back into place
  ${MV} ${SECRETFILE}_  ${SECRETFILE}

  # mark as secret being updated
  HAS_SECRET=1


  # Update local context if this was it
  retreiveLocalContextCluster
  if [ "${LOCALCONTEXT}" == "${CLUSTER}" ]; then
    if [ "$DOECHO" == "2" ]; then echo "  ... updating local context"; fi
    mkdir -p     "${WOV_CACHEDIR}/clusters/local"
    chmod -R 700 "${WOV_CACHEDIR}/clusters/local"
    if [ "${LOCALCONTEXT}" != "local" ]; then
      cp "${WOV_CACHEDIR}/clusters/${LOCALCONTEXT}/secrets.json" "${WOV_CACHEDIR}/clusters/local/secrets.json" 2> /dev/null
      if [ "$?" != "0" ]; then
        echo "ERROR: failed copy of secrets to cache dir 'clusters/local/secrets.json'." 1>&2
        exit 1
      fi
    fi
  fi

  # Is secret different from last run?
  local SECRETDIFF=1
  if [ -e "${SECRETFILELAST}" ]; then
    if [ "`diff ${SECRETFILE} ${SECRETFILELAST} && echo $?`" == "0" ]; then
      SECRETDIFF=0
        # --- no diff so turn this off
    fi
  fi

  if [ "$DOECHO" == "2" ] && [[ $SECRETDIFF -gt 0 ]]; then
    echo "... (re)build secrets for '${CLUSTER}'."
  fi

  # Update secret since it was used
  cp ${SECRETFILE} ${SECRETFILELAST}

  return ${SECRETDIFF}
}



# --------------------------------------------------------------------- 
# --------------------------------------------------------------------- 
function fCleanCacheAll() 
{
  HAS_CLEAN=1
  _fCleanCache "clusters" "secrets"
}
function _fCleanCache() 
{
  BUILDDIRS=( "$*" )
  for f in ${BUILDDIRS[@]}; do
    DEST=${WOV_BASEDIR}/wovtools/cache/$f
    if [ $DOECHO -ge 2 ]; then echo "  ... clean cache in dir '${DEST}'."; fi
    rm -fR ${DEST}/* || true
  done
}


# ---------------------------------------------------------------------
# build all .wov files in a directory
#   from ${WOV_BASEDIR}/wovtools/k8s}
#     to ${WOV_BASEDIR}/wovtools/cache/clusters/$1/k8s
# build cm/se files from containers
#     to ${WOV_BASEDIR}/wovtools/cache/clusters/$1/{cm|se}
#  $2 - 1 if secrets have changed
# ---------------------------------------------------------------------
fBuildClusterDir()
{
  # printf "\nfBuildClusterDir\n\n\n"
  local CLUSTER=$1
  if [ "$CLUSTER" == "" ]; then printf "\n\nERROR: no CLUSTER defined for building secret.\n\n"; exit 1; fi
  local CLUSTER_DIR="${WOV_CACHEDIR}/clusters/${1}"
  local SECRETFILE="${CLUSTER_DIR}/secrets.json"
  local SECRETFILELAST="${CLUSTER_DIR}/.last.json"


  # ---------------------------------------------------------------------
  # Clear out old files
  # ---------------------------------------------------------------------
  #_fCleanCache "clusters/${CLUSTER}/k8s" "clusters/${CLUSTER}/se" "clusters/${CLUSTER}/cm"


  # ---------------------------------------------------------------------
  # K8s files, compile
  # ---------------------------------------------------------------------
  mkdir -p  "${CLUSTER_DIR}/k8s"
  chmod 700 "${CLUSTER_DIR}/k8s"

  if [ -d ${WOV_BASEDIR}/wovtools/k8s ]; then

    # Find k8s files to compile
    WOVFILES=$(cd ${WOV_BASEDIR}/wovtools/k8s; ls *.wov 2> /dev/null)
    if [ "${WOVFILES}" == "" ]; then echo "  ... no files found in wovtools/k8s/*.wov."; fi

    # Compile them if needed
    for f in ${WOVFILES}; do

      # file versions 
      SRC=${WOV_BASEDIR}/wovtools/k8s/${f}
      DEST=${CLUSTER_DIR}/k8s/${f%.wov}

      # check if we need to compile
      # ------------------------
      local dowecompile=${DOFORCE}
      if [ "$2" == "1" ]; then dowecompile=1;                         # secrets changed?
      elif [ ! -e "${DEST}" ]; then dowecompile=1;                     # no dest file
      elif [ "${SRC}" -nt "${DEST}" ]; then dowecompile=1;             # src has changed after dest
        # elif [ "${SECRETFILE}" -nt "${DEST}" ]; then dowecompile=1;    # secrets have changed after dest
      fi

      # compile dir if needed
      if [[ ${dowecompile} -eq 1 ]]; then
        if [ "$DOECHO" == "2" ] || [ "$DOECHO" == "2" ]; then echo "  ... build ${SRC}"; fi
        #echo " --- `basename ${DEST}` needs to be built"
        #      echo "SHOULD CALL: wov-compile ${SECRETFILE} ${SRC} > ${DEST}"
        wov-compile ${SECRETFILE} ${SRC} > ${DEST}
      else
        if [ "$DOECHO" == "2" ]; then echo "  ... skipping ${SRC}"; fi
      fi

    done
  fi

  # ensure directories
  mkdir -p  "${CLUSTER_DIR}/cm"
  mkdir -p  "${CLUSTER_DIR}/se"
  chmod 700 "${CLUSTER_DIR}/cm"
  chmod 700 "${CLUSTER_DIR}/se"

  local hasbuiltbasecm=0
  local hasbuiltbasese=0

  # ---------------------------------------------------------------------
  # cm/se : build K8s ConfigMap and Secrets
  # ---------------------------------------------------------------------
  # Each container recipe is for a microservice

  local CONFS=(${WOV_PROJECT})
  if [ -d ${WOV_BASEDIR}/wovtools/containers ]; then
    local containers=$(cd ${WOV_BASEDIR}/wovtools/containers && find * -maxdepth 0 -type f 2> /dev/null)
    for con in ${containers[@]}; do
      CONFS+=( "${WOV_PROJECT}${con}" )
    done
  fi
#  echo "build CONFS ${CONFS[@]}"


  for f in ${CONFS[@]}; do

    # Create CM file to dump into and clear out
    # NOTE: if builing to CMFILE2, then all recipes would build that and only need to build once... TODO / OPTIMIZATION
    if [ $DOECHO -ge 2 ]; then echo "  ... review ConfigMap and Secret for '${f}${CONFEXT}'."; fi
    local CMFILE=${CLUSTER_DIR}/cm/${f}${CONFEXT}

    # Check if we need to compile K8s ConfigMap
    local dowecompile=${DOFORCE}
    if [ "$2" == "1" ]; then dowecompile=1;                                  # secrets changed?
    elif [ ! -e "${CMFILE}" ]; then dowecompile=1; # no CMFILE file
    elif [ -e "${CMFILE}" ] && [ ${CLUSTER_DIR}/secrets.json -nt "${CMFILE}" ]; then dowecompile=1; # existing CMFILE and old
    fi
    if [ $DOECHO -ge 2 ] && [ "${dowecompile}" == "1" ]; then echo "  ... compile ConfigMap and Secret for '${f}${CONFEXT}'."; fi

    # Compile K8s ConfigMap file
    if [ "${dowecompile}" == "1" ]; then 
      rm -f ${CMFILE} || true
      touch ${CMFILE}
      chmod 600 ${CMFILE}
      wov-env --cluster ${CLUSTER} --cm ${f} >> ${CMFILE} 2>&1
      local a=$?
      if [ "$a" == "1" ]; then
        if [ $DOECHO -ge 2 ]; then printf "  ... skipping ${CLUSTER}/cm/${f}.\n"; fi
        rm ${CMFILE} 
      elif [ "$a" == "2" ]; then
        printf "ERROR: failed generating configmap in cluster: '${CLUSTER}' for: '${f}'.\n" >&2
        cat ${CMFILE}
        exit 1
      else
        # sort and uniq to remove duplicates  #??? Needed anymore???
        touch ${CMFILE}  # make sure it exists
        touch ${CMFILE}.1
        chmod 600 ${CMFILE}.1
        sort ${CMFILE} | uniq >> ${CMFILE}.1
        mv ${CMFILE}.1 ${CMFILE}
        if [ $DOECHO -ge 1 ]; then printf "  ... compiled ${CLUSTER}/cm/${f}.\n"; fi
      fi
    fi

    local SEFILE=${CLUSTER_DIR}/se/${f}${CONFEXT}

    # Check if we need to compile K8s Secrets
    local dowecompile=${DOFORCE}
    if [ "$2" == "1" ]; then dowecompile=1;                                 # secrets changed?
    elif [ ! -e "${SEFILE}" ] && [ ! -e "${SEFILE}" ] ; then dowecompile=1; # no SEFILE file
    fi

    # Compile K8s Secret file
    if [ "${dowecompile}" == "1" ]; then 
      rm -f ${SEFILE} || true
      touch ${SEFILE}
      chmod 600 ${SEFILE}
      wov-env --cluster ${CLUSTER} --se ${f} >> ${SEFILE} 2>&1
      local a=$?
      if [ "$a" == "1" ]; then
        if [ $DOECHO -ge 2 ]; then printf "  ... skipping ${CLUSTER}/se/${f}.\n"; fi
        rm ${SEFILE} 
      elif [ "$a" == "2" ]; then
        printf "ERROR: failed generating secret in cluster: '${CLUSTER}' for: '${f}'.\n" >&2
        cat ${SEFILE}
        exit 1
      else
        # sort and uniq to remove duplicates  #??? Needed anymore???
        touch ${SEFILE}  # make sure it exists
        touch ${SEFILE}.1
        chmod 600 ${SEFILE}.1
        sort ${SEFILE} | uniq >> ${SEFILE}.1
        mv ${SEFILE}.1 ${SEFILE}
        if [ $DOECHO -ge 1 ]; then printf "  ... compiled ${CLUSTER}/se/${f}.\n"; fi
      fi
    fi
  done



#  local RECIPES=( )   # here, specify 
#  if [ "${#RECIPES[@]}" == "0" ]; then
#    if [ -d ${WOV_BASEDIR}/wovtools/containers ]; then
#      RECIPES=$(cd ${WOV_BASEDIR}/wovtools/containers && find * -maxdepth 0 -type f 2> /dev/null)
#    fi
#  fi
#  #echo "Container Recipes: ${RECIPES}"



#  # Build ConfigMap and Secrets if needed
#  for f in ${RECIPES}; do
#
#    local CONTAINERNAME=$f
#    local MICROSERVICE=${WOV_PROJECT}${CONTAINERNAME}
#    if [ $DOECHO -ge 2 ]; then echo "... build ConfigMap and Secret for '${MICROSERVICE}${CONFEXT}'."; fi
#
#    # Create CM file to dump into and clear out
#    # NOTE: if builing to CMFILE2, then all recipes would build that and only need to build once... TODO / OPTIMIZATION
#    local CMFILE1=${CLUSTER_DIR}/cm/${MICROSERVICE}${CONFEXT}
#    local CMFILE2=${CLUSTER_DIR}/cm/${WOV_PROJECT}${CONFEXT}
#
#    # Check if we need to compile K8s ConfigMap
#    local dowecompile=${DOFORCE}
#    if [ "$2" == "1" ]; then dowecompile=1;                                  # secrets changed?
#    elif [ ! -e "${CMFILE1}" ] && [ ! -e "${CMFILE2}" ] ; then dowecompile=1; # no CMFILE file
#    elif [ -e "${CMFILE1}" ] && [ ${CLUSTER_DIR}/secrets.json -nt "${CMFILE1}" ]; then dowecompile=1; # existing CMFILE1 and old
#    elif [ -e "${CMFILE2}" ] && [ ${CLUSTER_DIR}/secrets.json -nt "${CMFILE2}" ]; then dowecompile=1; # existing CMFILE2 and old
#    fi
#
#    # Compile K8s ConfigMap file
#    if [ "${dowecompile}" == "1" ]; then 
#      local CMFILE="${CMFILE1}"
#      rm -f ${CMFILE} || true
#      touch ${CMFILE}
#      chmod 600 ${CMFILE}
#      wov-env --cluster ${CLUSTER} --cm ${MICROSERVICE} >> ${CMFILE} 2>&1
#      local a=$?
#      if [ "$a" == "2" ]; then
#        printf "ERROR: failed generating configmap in cluster: '${CLUSTER}' for microservice: '${MICROSERVICE}'.\n" >&2
#        cat ${CMFILE}
#        exit 1
#      fi
#      if [ "$a" != "0" ]; then
#        rm ${CMFILE}
#        CMFILE="${CMFILE2}"
#        rm ${CMFILE}
#        if [ "$hasbuiltbasecm" == "0" ]; then
#          if [[ $DOECHO -ge 2 ]]; then echo "  ... using config for ${WOV_PROJECT}, instead of ${MICROSERVICE}"; fi
#          wov-env --cluster ${CLUSTER} --cm ${WOV_PROJECT} >> ${CMFILE}
#          local a=$?
#          if [ "$a" == "2" ]; then
#            printf "ERROR: failed generating configmap in cluster: '${CLUSTER}' for project: '${WOV_PROJECT}'.\n" >&2
#            cat ${CMFILE}
#            exit 1
#          fi
#          if [ "$a" != "0" ]; then exit 1; fi
#          hasbuiltbasecm=1
#          if [ "${DOECHO}" == "2" ]; then echo "  ... compiled ${CMFILE}."; fi
#        fi
#      else
#        if [ "${DOECHO}" == "2" ]; then echo "  ... compiled ${CMFILE}."; fi
#      fi
#
#      # sort and uniq to remove duplicates
#      touch ${CMFILE}  # make sure it exists
#      touch ${CMFILE}.1
#      chmod 600 ${CMFILE}.1
#      sort ${CMFILE} | uniq >> ${CMFILE}.1
#      mv ${CMFILE}.1 ${CMFILE}
#
#    else
#      if [ "${DOECHO}" == "2" ]; then echo "  ... skipped K8s ConfigMap file."; fi
#    fi
#
#    # Create SE file to read in
#    local SEFILE1=${CLUSTER_DIR}/se/${MICROSERVICE}${CONFEXT}
#    local SEFILE2=${CLUSTER_DIR}/se/${WOV_PROJECT}${CONFEXT}
#
#    # Check if we need to compile K8s Secrets
#    local dowecompile=${DOFORCE}
#    if [ "$2" == "1" ]; then dowecompile=1;                                  # secrets changed?
#    elif [ ! -e "${SEFILE1}" ] && [ ! -e "${SEFILE2}" ] ; then dowecompile=1; # no SEFILE file
#    fi
#
#    # Compile K8s Secrets file
#    if [ "${dowecompile}" == "1" ]; then
#      local SEFILE="${SEFILE1}"
#      rm -f ${SEFILE} || true
#      touch ${SEFILE}
#      chmod 600 ${SEFILE}
#      wov-env --cluster ${CLUSTER} --se ${MICROSERVICE} >> ${SEFILE} 2>&1
#      local a=$?
#      if [ "$a" == "2" ]; then
#        printf "ERROR: failed generating configmap in cluster: '${CLUSTER}' for microservice: '${MICROSERVICE}'.\n" >&2
#        cat ${SEFILE}
#        exit 1
#      fi
#      if [ "$a" != "0" ]; then
#        rm ${SEFILE}
#        SEFILE="${SEFILE2}"
#        if [ "$hasbuiltbasese" == "0" ]; then
#          wov-env --cluster ${CLUSTER} --se ${WOV_PROJECT} >> ${SEFILE}
#          local a=$?
#          if [ "$a" == "2" ]; then
#            printf "ERROR: failed generating configmap in cluster: '${CLUSTER}' for project: '${WOV_PROJECT}'.\n" >&2
#            cat ${SEFILE}
#            exit 1
#          fi
#          if [ "$?" != "0" ]; then exit 1; fi
#          hasbuiltbasese=1
#          if [ "${DOECHO}" == "2" ]; then echo "  ... compiled ${SEFILE}."; fi
#        fi
#      else
#        if [ "${DOECHO}" == "2" ]; then echo "  ... compiled ${SEFILE}."; fi
#      fi
#
#      # sort and uniq to remove duplicates
#      touch ${SEFILE}   # make sure it exists
#      touch ${SEFILE}.1
#      chmod 600 ${SEFILE}.1
#      sort ${SEFILE} | uniq >> ${SEFILE}.1
#      mv ${SEFILE}.1 ${SEFILE}
#
#    else
#      if [ "${DOECHO}" == "2" ]; then echo "  ... skipped K8s Secret file."; fi
#    fi
#
#  done


  # mark as done
  HAS_BUILDENV=1

}



# --------------------------------------------------------------------- 
# Handle Params
# --------------------------------------------------------------------- 
while [[ $1 =~ ^- ]]; do
#  echo "param '$1'"

  if [ "$1" == "-q" ]; then
    shift
    DOECHO=0

#  elif [ "$1" == "-i" ]; then
#    shift
#    DONSIGNORE=1

  elif [ "$1" == "-v" ]; then
    shift
    DOECHO=2

  elif [ "$1" == "--local" ]; then
    shift
    fBuildLocalSecrets

  elif [ "$1" == "-s" ] || [ "$1" == "--secrets" ]; then
    shift
    fBuildSecrets $1
    shift

  elif [ "$1" == "-n" ] || [ "$1" == "--namespace" ]; then
    echo "ERROR: '$1 $2' is a leading command and should be placed at start of command arguments."
    exit 1

  elif [ "$1" == "-g" ] || [ "$1" == "--global" ]; then
    printf "\n\nERROR: '$1' needs to be first param in args array. Retype your command.\n\n"
    exit 1

  elif [ "$1" == "-c" ] || [ "$1" == "--cluster" ]; then
    shift
    fBuildSecrets $1
    SECRETDIFF=$?
    fBuildClusterDir $1 ${SECRETDIFF}
    shift

#  elif [ "$1" == "-s" ] || [ "$1" == "--secrets" ]; then
#    echo "IMPLEMENT THIS: do multiple calls to fBuildSecrets X and fBuildClusterDir X"
#    exit 1
#    shift
#    if [ "$DONSIGNORE" == "0" ]; then
#      buildargs=( "$@" )
#      set ""
#      . wov-ns-check
#      set -- "${buildargs[@]}"
#    fi
#    fBuildSecrets


#  elif [ "$1" == "-k" ]; then
#    echo "IMPLEMENT THIS: do multiple calls to fBuildSecrets X and fBuildClusterDir X"
#    exit 1
#    shift
#    fBuildClusterDir $1
#    shift

  elif [ "$1" == "--clean" ]; then
    shift
    fCleanCacheAll

  elif [ "$1" == "-f" ] || [ "$1" == "--force" ]; then
    shift
    DOFORCE=1

  elif [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
    fWovEnvBuildDisplayOptions
    exit 0

  else
    echo
    echo "***ERROR: unknown option '$1'."
    echo
    fWovEnvBuildDisplayOptions
    exit 1
  fi
done


if [[ ${HAS_SECRET} -eq 0 ]] && [[ ${HAS_BUILDENV} -eq 0 ]] && [[ ${HAS_CLEAN} -eq 0 ]]; then
  echo
  echo "ERROR: no command passed."
  echo
  fWovEnvBuildDisplayOptions
  exit 1
fi
